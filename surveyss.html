<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Surveying the Solar System</title>
  <meta name="description"
    content="How to survey the solar system using only naked-eye observations.">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>MathJax = {tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }};
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
          id="MathJax-script">
  </script>
  <style>
    .down-arrow {
        width: 2rem; height: 2rem; margin: auto;      
        border-bottom: solid gray 0.5rem;             
        border-left: solid gray 0.5rem;               
        border-radius: 0.5rem;                        
        transform: translateY(-1rem) rotate(-45deg);
        cursor: pointer;
    }
    .up-arrow {
        width: 2rem; height: 2rem; margin: auto;      
        border-bottom: solid gray 0.5rem;             
        border-left: solid gray 0.5rem;               
        border-radius: 0.5rem;                        
        transform: translateY(0.6rem) rotate(135deg);
        cursor: pointer;
    }
    .unselectable {
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10 and IE 11 */
        user-select: none; /* Standard syntax */
    }
    .xl-gekko {
        font-size: 18pt;
    }
    .xl-webkit {
        font-size: 20pt;
    }
  </style>
</head>

<body>

  <div id="top-div" class="unselectable">
    <div style="position: relative">
      <div style="display: none;">
        <!-- These two divs will be moved into the clock svg below. -->
        <div id="intro"
             style="width: 75%; padding: 1em 2.5em;
                    transform: translate(0, 0);
                    background: #eeec; transition: transform 250ms;">
          <!-- 20pt font optimal for chrome, 18pt for firefox -->
          <ul class="xl-gekko" style="list-style-type: none;
                     font-family: serif; font-weight: normal;
                     padding: 0ex 1ex; border: 4px solid gray;
                     border-radius: 1em; background: #fffc;">
            <li style="padding: 1ex 0ex;">This "planet clock" shows
              the positions of the Sun and planets as they move through the
              constellations of the Zodiac
              <a href="https://ssd.jpl.nasa.gov/planets/approx_pos.html">for
                any date</a> between 5000 years ago and 1000 years
                from now.</li>
            <li style="padding: 1ex 0ex;">You can watch the Sun and
              planets move through the stars, just as you can by
              looking at the sky with your own eyes.
            </li>
            <li style="padding: 1ex 0ex;">Do you see evidence that the
              planets orbit the Sun and not the Earth?  That Earth is
              the third planet?  Can you figure out the order of the
              planets from the Sun?  How would you test these
              ideas?</li>
            <li><div class="down-arrow" onclick="removeIntro()"></div></li>
          </ul>
        </div>
        <div id="intro-restore" style="display: none;">
          <div class="up-arrow" onclick="restoreIntro()"></div>
        </div>
      </div>
    <div id="top-clock"
         style="min-width: 450px; max-width: 750px; position: relative;
                margin: auto;">
    </div>
    </div>
    <div id="right-side"
         style="position: relative; min-width: 400px; max-width: 650px; flex: 1">
      <!-- without the width:100% style in both following nested divs,
           chrome will compute the inner svg size to be 0x0 -->
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="orb-view"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="earth-year"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="mars-year"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="survey-orbits"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="mars-incline"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="two-laws"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
      <div style="position: absolute; top: 50px; left: 0; width: 100%">
        <div id="third-law"
             style="position: static; width: 100%; height: 100%; display: none;">
        </div>
      </div>
    </div>
  </div>

<!-- J2000 Zodiac boundaries:
Pisces 28.687 Aries 53.417 Taurus 90.140 Gemini 117.988 Cancer 138.038
Leo 173.851 Virgo 217.810 Libra 241.047 Scorpius 247.638 Ophiuchus 266.238
Sagittarius 299.656 Capricornus 327.488 Aquarius 351.650 Pisces

~400 BC?  beginning of Cancer at beta-Geminorum, of Aquarius at delta-Capricorn
Pisces 0 Aries 30 Taurus 60 Gemini 90 Cancer 120 Leo 150 Virgo 180
Libra 210 Scorpio 240 Sagittarius 270 Capricornus 300 Aquarius 330 Pisces
-->

<!-- Load d3 library.  Later should grab only pieces used.
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.4.4/d3.min.js"></script>
-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.4.4/d3.js"></script>
<script src="./ephemeris.js"></script>
<script src="./planetclock.js"></script>
<script>

  // Probably should not do this...
  if (navigator.userAgent.indexOf("AppleWebKit/") >= 0) {
    document.querySelectorAll(".xl-gekko").forEach(
      e => {
        e.classList.toggle("xl-gekko");
        e.classList.toggle("xl-webkit");
      });
  }

  let clock = new PlanetClock(d3.select("#top-clock"));
  clock.goToDay(dayOfDate(new Date()));
  clock.hasMoonButton(true);
  clock.disabled = true;
  let introCover = clock.svg.append("foreignObject")
      .attr("xmlns", "http://www.w3.org/1999/xhtml")
      .attr("width", "100%").attr("height", "100%")
      .attr("x", 63-375).attr("y", 91-375);
  introCover.append(() => d3.select("#intro").node());
  clock.svg.append("foreignObject")
    .attr("xmlns", "http://www.w3.org/1999/xhtml")
    .attr("width", "10%").attr("height", "7%")
    .attr("x", 300).attr("y", 330)
    .append(() => d3.select("#intro-restore").node());

  function removeIntro() {
    const intro = d3.select("#intro");
    let node = intro.node();
    intro.style("transform", "translate(675px, 675px) scale(0.1)");
    d3.timeout(
      () => {
        introCover.style("display", "none");
        d3.select("#intro-restore").style("display", null);
        clock.disabled = false;
      }, 260);
  }

  function restoreIntro() {
    const intro = d3.select("#intro");
    introCover.style("display", null);
    d3.timeout(() => intro.style("transform", "translate(0, 0)"), 10);
    d3.timeout(
      () => {
        d3.select("#intro-restore").style("display", "none");
        clock.disabled = true;
      }, 260);
  }

  /*
  let moonButton = d3.select("#top-div").append("div")
      .style("position", "absolute")
      .style("top", "1%").style("left", "1%")
      .append("button")
      .style("cursor", "pointer")
      .text("Show Moon");
  let moon = {state: false};
  function toggler() {
    if (moon.state) {
      clock.turnOffMoon();
      moon.state = false;
      moonButton.text("Show Moon");
    } else {
      clock.turnOnMoon();
      moon.state = true;
      moonButton.text("Hide Moon");
    }
  }
  moonButton.on("click", toggler);
  */

  let orbView = new OrbitView(d3.select("#orb-view"), clock);
  let earthYear = new EarthYear(d3.select("#earth-year"), clock);
  let marsYear = new MarsYear(d3.select("#mars-year"), clock);
  let surveyor = new SurveyOrbits(d3.select("#survey-orbits"),
                                  clock, marsYear, earthYear);
  let incline = new Inclination(d3.select("#mars-incline"),
                                clock, surveyor);
  let twoLaws = new TwoLaws(d3.select("#left-side"), d3.select("#two-laws"),
                            incline);
  let thirdLaw = new ThirdLaw(d3.select("#left-side2"), d3.select("#third-law"),
                             incline);
  let slaves = [null, orbView, earthYear, marsYear, surveyor, incline,
                twoLaws, thirdLaw];
  let bothSides = [false, false, false, false, false, false,
                   true, true];
  let iselPrev = -1;

  function planetSelect() {
    let sel = document.getElementById("planet-menu");
    twoLaws.setPlanet(sel.options[sel.selectedIndex].value);
  }

  function allPlanetSelect() {
    let sel = document.getElementById("all-planet-menu");
    thirdLaw.setPlanet(sel.options[sel.selectedIndex].value);
  }

  function mainMenuSelect() {
    ["mercury", "venus", "jupiter", "saturn"].forEach(
      p => clock.setHandVisibility(p, false));
    let sel = document.getElementById("main-menu");
    sel = sel.options[sel.selectedIndex].value;
    let isel = -1;
    ["#intro", "#orb-view", "#earth-year", "#mars-year",
     "#survey-orbits", "#mars-incline", "#two-laws", "#third-law"].forEach(
      (id, i) => {
        if (id != sel) {
          d3.select(id).style("display", "none");
        } else {
          isel = i;
        }
      }
    );
    d3.select(sel).style("display", "block");
    if (bothSides[isel]) {
      d3.select("#top-clock").style("display", "none");
      d3.select("#top-non-clock").style("display", null);
      if (sel === "#two-laws") {
        d3.select("#third-law-title").style("display", "none");
        d3.select("#two-laws-title").style("display", null);
        d3.select("#left-side2").style("display", "none");
        d3.select("#left-side").style("display", null);
      } else {
        d3.select("#two-laws-title").style("display", "none");
        d3.select("#third-law-title").style("display", null);
        d3.select("#left-side").style("display", "none");
        d3.select("#left-side2").style("display", null);
      }
    } else {
      d3.select("#top-non-clock").style("display", "none");
      d3.select("#top-clock").style("display", null);
    }
    clock.setHandVisibility(
      "mars", ["#orb-view", "#mars-year",
               "#survey-orbits", "#mars-incline"].indexOf(sel) > -1);
    if (slaves[iselPrev] != null) {
      slaves[iselPrev].activate(false);
    } else {
      moonButton.style("display", "none");
      if (moon.state) clock.turnOffMoon();
    }
    iselPrev = isel;
    if (slaves[isel] != null) {
      slaves[isel].activate(true);
    } else {
      clock.removeElapsed();
      moonButton.style("display", "inline-block");
      if (moon.state) clock.turnOnMoon();
    }
  }

  // Interpret URL query parameters
  // tab=orb-view  (intro, orb-view, earth-year, ... main select id)
  // day=8114      (clock.elapsed0 JD minus J2000 day number)
  // eyear=365.25636  (earthYear period value, otherwise unused)
  // myear=686.979  (marsYear.yearEstimate value)
  // oppo=0        (surveyor.iOppo opposition index)
  let urlQueries = location.search.replace("\?", "");
  if (urlQueries) {
    urlQueries = Object.fromEntries(urlQueries.split("&")
                                    .map(q => q.split("=")));
  } else {
    urlQueries = {}
  }
  if (urlQueries.tab &&
      ["intro", "orb-view", "earth-year", "mars-year", "survey-orbits",
       "mars-incline", "two-laws", "third-law"].indexOf(urlQueries.tab)) {
    let sel = document.getElementById("main-menu");
    sel.value = "#" + urlQueries.tab;
    // mainMenuSelect() will be called below to emulate onchange callback
  }
  if (urlQueries.eyear && !isNaN(urlQueries.eyear)) {
    let year = parseFloat(urlQueries.eyear);
    if (year < 350) year = 350;
    else if (year > 380) year = 380;
    earthYear.changeYearEstimate(year);
  }
  if (urlQueries.day && !isNaN(urlQueries.day)) {
    let day = parseFloat(urlQueries.day);
    clock.goToDay(day);
    clock.elapsed0 = day;
    earthYear.elapsedUpdate(true);
    marsYear.elapsedUpdate(true);
    if (urlQueries.myear && !isNaN(urlQueries.myear)) {
      let year = parseFloat(urlQueries.myear);
      if (year < 650) year = 650;
      else if (year > 730) year = 730;
      marsYear.changeYearEstimate(year);
    } else {
      marsYear.changeYearEstimate(686.97973);
    }
    if (!urlQueries.eyear) {
      earthYear.changeYearEstimate(365.25636);
    }
    surveyor.notReady();
    if (urlQueries.oppo && !isNaN(urlQueries.oppo)
        && surveyor.oppositionsFound) {
      let iOppo = parseInt(urlQueries.oppo);
      if (iOppo >= 0 && iOppo < surveyor.oppositionsFound.length) {
        surveyor.selector(undefined, [undefined, iOppo]);
      }
    } else {
      surveyor.selector(undefined, [undefined, 0]);
    }
    surveyor.findEarth();
    surveyor.findMars();
  }

  // On page reload, select element remembers previous setting, so
  // mainMenuSelect();

</script>


</body>
</html>
